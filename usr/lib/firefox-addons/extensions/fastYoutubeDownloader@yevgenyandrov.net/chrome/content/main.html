<html>
    <head>
		<title></title>
		
		<style>
		   html {
			width:100%;
			height:100%;
			margin:0px;
			padding:0px;
			overflow:hidden;
		   }

		   body {
			width:100%;
			height:100%;
			margin:0px;
			padding:0px;
			overflow:hidden;
		   }
		   #bar {
		     border-top:1px solid #000000;
		     background-color:#ff0000;
			 background-image:url(images/barBackground.png);
			 background-repeat:repeat-x;
		     width:100%;
		     height:62px;
		   }
		   #bar-download-container {
		     position:relative;

		     float:left;
		   //  width:100%;
		     height:62px;
			 overflow:hidden;
		   }
		   #download-container {
		    // width:20000px;
		     position:absolute;
		   }


		   #right {
			 width:20px;
			 height:100%;
			 background-image:url(images/arrow_big.png);
			 background-repeat:no-repeat;
			// background-color:#ff0000;
		 	 float:right;
			 cursor:pointer;
		   }
		   #right.small {
			 background-image:url(images/arrow_small.png);
			 background-repeat:no-repeat;		   
		   }

		   .videoDownloadItem {
		   //  float:left;
		   position:absolute;
			 width:211px;
			 margin-left:3px;
			 margin-right:10px;
			 background-image:url(images/downloadItemBackground.png);
			 background-repeat:repeat-x;
			 height:49px;
			 margin-top:5px;
		     -moz-border-radius: 4px;
			 border:1px solid #4c1b29;
		     -moz-box-shadow:1px 1px 3px #333333;
			 -moz-user-select : none;
		   }

		   .videoDownloadItem.finish {
		     cursor:pointer;
			 background-image:url(images/downloadItemBackgroundFinish.png);
			 background-repeat:repeat-x;
		   }
		   .videoDownloadItem.canceled {
			 background-image:url(images/downloadItemBackgroundCanceled.png);
			 background-repeat:repeat-x;
		   }
		   .right {
		     float:right;
		     width:16px;
			 height:49px;
			 background-image:url(images/arrowBackground.png);
			 background-repeat:repeat-x;
		     -moz-border-radius-topright: 3px;
		     -moz-border-radius-bottomright: 3px;
			 border-left:1px solid #434f1c;
		   }




		   .arrow {
		     width:8px;
			 height:9px;
			 background-image:url(images/arrow.png);
			 background-repeat:no-repeat;
			 margin-top:22px;
			 margin-left:4px;
		   }


		   div.right:hover {
			 background-image:url(images/arrowBackgroundOver.png);
			 background-repeat:repeat-x;
			 cursor:pointer;
		   }


		   .videoDownloadItem.finish .right {
			 background-image:url(images/arrowBackgroundFinish.png);
			 background-repeat:repeat-x;
			 border-left:1px solid #657337;
		   }
		   .videoDownloadItem.finish div.right:hover {
			 background-image:url(images/arrowBackgroundFinishOver.png);
			 background-repeat:repeat-x;
		   }

		   .videoDownloadItem.canceled .right {
		     background-color:#545541;
			 background-image:url("");
			 background-repeat:repeat-x;
			 border-left:1px solid #72745b;
		   }

		   .videoDownloadItem.canceled div.right:hover{
		     background-color:#414231;
			 background-image:url("");
			 background-repeat:repeat-x;
			 border-left:1px solid #72745b;
		   }
		   .title {
			   float:left;
		       font-family:arial;
			   font-size:11px;
			   color:#262e0f;
			   height:29px;
			   margin-left:5px;
			   margin-top:1px;
			   width:119px;
			   overflow:hidden;
			   cursor:default;
		   }
		   .progress {
			   float:left;
			   position:relative;
		       background-color:#78864c;
		       width:70px;
			   height:14px;
			   margin-left:3px;
			   width:119px;
			   margin-top:1px;
		       -moz-border-radius: 3px;
			   border:1px solid #636b4c;
			   text-align:center;
		   }
		   .progressBar {
			   float:left;
			   position:absolute;
			   z-index:0;
		       background-color:#27300a;
		       width:0%;
			   height:14px;
		       -moz-border-radius: 2px;
		   }
		   .progressBarText {
			 //  float:left;
			  position:relative;
		       font-family:arial;
			   font-size:10px;
			   color:#ffffff;
			   z-index:2;
			   cursor:default;

		   }
		   .thumbnail {
			   float:left;
		       background-color:#481345;
		       width:62px;
			   height:43px;
			   border:1px solid #4b5233;
			   margin-left:2px;
			   margin-top:2px;
		   }


		   .completedIcon {
		     float:left;
		     width:14px;
			 height:14px;
			 background-image:url(images/completedIcon.png);
			 background-repeat:no-repeat;
			 margin-left:3px;
			 margin-top:1px;
			 padding-left:17px;
			 padding-top:1px;
		     font-family:arial;
			 font-size:10px;
			 color:#485816;
			  -moz-user-select : none;
		   }

		   .canceledIcon {
		     float:left;
		     width:14px;
			 height:14px;
			 background-image:url(images/canceldIcon.png);
			 background-repeat:no-repeat;
			 margin-left:3px;
			 margin-top:1px;
			 padding-left:17px;
			 padding-top:1px;
		     font-family:arial;
			 font-size:10px;
			 color:#2c1d1f;
			  -moz-user-select : none;
		   }
			
		   #scroll-left {
		     float:left;
		     width:20px;
			 height:21px;
			 background-image:url(images/scrollLeft.png);
			 background-repeat:no-repeat;
			 cursor:pointer;
		   }
			
		   #scroll-right {
		     float:right;
		     width:20px;
			 height:21px;
			 background-image:url(images/scrollRight.png);
			 background-repeat:no-repeat;
			 cursor:pointer;
		   }		   
		</style>

	    <script type="text/javascript" src="Tween.js"></script>
        <script language="javascript">

			var MODE = 1;
			var nsIDOMWindow;
			var currentDownloads = new Array();
			var downloadCounter = 0;
			function pageLoaded() {
				nsIDOMWindow = window.QueryInterface(Components.interfaces.nsIInterfaceRequestor)
										  .getInterface(Components.interfaces.nsIWebNavigation)
										  .QueryInterface(Components.interfaces.nsIDocShellTreeItem)
										  .rootTreeItem
										  .QueryInterface(Components.interfaces.nsIInterfaceRequestor)
										  .getInterface(Components.interfaces.nsIDOMWindow);	
				nsIDOMWindow.fastYoutubeDownloader.addVideoDownload = addVideoDownload;
				if (nsIDOMWindow.fastYoutubeDownloader.p.maximize) {
					MODE = 1;
				} else {
					MODE = 0;
				}

				$("bar").addEventListener("contextmenu", openVideoDownloadMenu, false);
				window.addEventListener("resize", resize, false); 

				resize();
				if (MODE==0) {
					$("bar").style.height = "43px";		
				}
				$("scroll-left").addEventListener("click", function() {
					scrollDownloadBar(1);
				}, false); 
				$("scroll-right").addEventListener("click", function() {
					scrollDownloadBar(-1);
				}, false); 
			}


			var currentScrollItem = 0;
			var scrollTween = null;
			function scrollDownloadBar(delta) {
				if (MODE==0) {
					var maxItems = Math.floor($("bar-download-container").clientWidth/ (211 - 64 + 10));
				  } else {
					var maxItems = Math.floor($("bar-download-container").clientWidth/ (211 + 10));
				}
				
				currentScrollItem += delta;
				if ($("download-container").childNodes.length + currentScrollItem<=maxItems) currentScrollItem = maxItems - $("download-container").childNodes.length
				if (currentScrollItem>0) currentScrollItem = 0;
				if (MODE==0) {
					var posDelta = (211 - 64 + 10);
				  } else {
					var posDelta = (211 + 10);
				}
				if ($("download-container").style.left==null) $("download-container").style.left = "0px";
				if (scrollTween!=null) scrollTween.stop();
				scrollTween = new Tween($("download-container").style,'left',Tween.strongEaseOut, parseFloat($("download-container").style.left), currentScrollItem * posDelta,1,'px');
				scrollTween.start();
			}
			function resize() {
				setItemsPosition();
				$("right").addEventListener("click", setMode, false); 
				checkScroller();
			}

			function checkScroller() {
				var totalWidth = 0;
			    var width  = $("bar").clientWidth;
				if (MODE==0) {
					totalWidth = $("download-container").childNodes.length * (211 - 64 + 10);
				  } else {
					totalWidth = $("download-container").childNodes.length * (211 + 10);
				}

				if (totalWidth<$("bar-download-container").clientWidth) {
				    $("bar-download-container").style.width = (width - 21) +"px"
					$("scroll-right").style.display = 'none';
					$("scroll-left").style.display  = 'none';
				} else {
					$("scroll-right").style.display = 'block';
					$("scroll-left").style.display  = 'block';
					$("bar-download-container").style.width = (width - 21 - 40) +"px"
				}			
			}

			function setItemsPosition() {
			
			    var pos = 3;
				var c = $("download-container").childNodes
				for (var i=0;i<c.length;i++) {
					c[i].style.left = pos + "px";
					if (MODE==0) {
					    pos += 211 - 64 + 10;
					} else {
						pos += 211 + 10;
					}
				//	c[i].downloadItem.style.display ="none";
				}
				if (scrollTween!=null) scrollTween.stop();
				$("download-container").style.left = "0px"
				currentScrollItem = 0;
									
			}
			function setMode(mode) {
				MODE = 1 - MODE;
			    if (MODE==0) {
					var c = $("download-container").childNodes
					for (var i=0;i<c.length;i++) {
						setItemByMode(c[i]);
					}		
					setItemsPosition();
					$("bar").style.height = "43px";
					nsIDOMWindow.fastYoutubeDownloader.setHeight(43);
					$("right").className = "small";
				} else {
					var c = $("download-container").childNodes
					for (var i=0;i<c.length;i++) {
					    setItemByMode(c[i]);
					}		
					setItemsPosition();		
					$("bar").style.height = null;
					nsIDOMWindow.fastYoutubeDownloader.setHeight(62);
					$("right").className = "";
				}
				checkScroller();
			}

			function setProgress(curTotalProgress, maxTotalProgress, completed, downloadItem) {
					var f = "kb"
					var downloadComplete = maxTotalProgress/1024;
					if (downloadComplete>1024) {
						f = "Mb"
						downloadComplete = downloadComplete/1024;
					}
					if (downloadComplete>1024) {
						f = "Gb"
						downloadComplete = downloadComplete/1024;
					}
					var progressBar = downloadItem.progressBar;
					progressBar.style.width  = parseFloat(completed) + "%";
					
					var progressBarText = downloadItem.progressBarText;
					progressBarText.innerHTML = Math.round(downloadComplete) + f + " ("+ Math.floor(completed) +"%)"

					if (curTotalProgress>=maxTotalProgress) {
						setCompleted(downloadItem);
					}
			} 


			function hideDownloadItem(downloadItem, callback) {

				var hide = function() {
					if (counter>0) {
						counter -= 0.07;
						div.style.opacity = counter;
					} else {
						clearInterval(interval);
						if (callback!=null) callback.apply(this);
					}
				}
				var div = downloadItem.div;
				if (div.style.opacity=="") div.style.opacity = 1;
				var counter = 1;
				var interval = setInterval(hide, 1);
			}

			function showDownloadItem(downloadItem, url, callback) {
				var show = function() {
					if (counter<1) {
						counter += 0.03;
						div.style.opacity = counter;
					} else {
						clearInterval(interval);
						if (callback!=null) callback.apply(this);
					}
				}
				
				var div = downloadItem.div;
				if (div.style.opacity=="") return;
				var counter = 0;
				var interval = setInterval(show, 1);
			}

			function setCompleted(downloadItem) {
				var div = downloadItem.div;
				div.setAttribute("class", "videoDownloadItem finish");
				div.progress.style.display='none';
				if (MODE==1) {
					div.completed.style.display='';
				}
				downloadItem.status = 2;
			}
			function setCanceled(downloadItem) {
				var div = downloadItem.div;
				div.setAttribute("class", "videoDownloadItem canceled");
				div.progress.style.display='none';
				if (MODE==1) {
					div.canceled.style.display='';
				}
				div.thumbnail.style.opacity = "0.5";

				downloadItem.status = -1;
			}

			function setItemByMode(item) {
				if (MODE==0) {
						item.thumbnail.style.display = 'none';
						item.progress.style.display = 'none';
						item.completed.style.display = 'none';
						item.canceled.style.display = 'none';
						item.style.width = (211 - 64) + "px";
						item.style.height = (30) + "px";
						item.right.style.height = (30) + "px";
						item.right.arrow.style.marginTop = (13) + "px";
				} else {
						item.thumbnail.style.display = 'block';
						if (item.downloadItem.status==1) item.progress.style.display = 'block';
						if (item.downloadItem.status==2) item.completed.style.display = 'block';
						if (item.downloadItem.status==-1) item.canceled.style.display = 'block';
						item.style.width = null;
						item.style.height = null;
						item.right.style.height = null;
						item.right.arrow.style.marginTop = null;
				}
			}
			function addVideoDownload(video) {
				var div = document.createElement("div");
				div.style.opacity = 0;
				div.setAttribute("class", "videoDownloadItem");
				div.setAttribute("title", video.title);
				
				div.addEventListener("contextmenu", openVideoDownloadMenu, false);

				var right = document.createElement("div");
				right.setAttribute("class", "right");
				div.right = right;
				div.appendChild(right);
				right.addEventListener("click", openVideoDownloadMenu, false);

				var arrow = document.createElement("div");
				arrow.setAttribute("class", "arrow");
				right.arrow = arrow;
				right.appendChild(arrow);

				var thumbnail = document.createElement("img");
				thumbnail.setAttribute("class", "thumbnail");
				thumbnail.setAttribute("src", video.thumbnailURL);
				div.thumbnail = thumbnail;
				div.appendChild(thumbnail);

				var title = document.createElement("div");
				title.setAttribute("class", "title");
				title.innerHTML = video.title;
				div.appendChild(title);

				var progress = document.createElement("div");
				progress.setAttribute("class", "progress");
				div.appendChild(progress);
				var progressBar = document.createElement("div");
				progressBar.setAttribute("class", "progressBar");
				progress.appendChild(progressBar);
				var progressBarText = document.createElement("div");
				progressBarText.setAttribute("class", "progressBarText");
				progress.appendChild(progressBarText);
				div.progress = progress;

				var completed = document.createElement("div");
				completed.setAttribute("class", "completedIcon");
				completed.innerHTML = "Completed"
				completed.style.display = 'none';
				div.completed = completed;
				div.appendChild(completed);

				var canceled = document.createElement("div");
				canceled.setAttribute("class", "canceledIcon");
				canceled.innerHTML = "Canceled"
				canceled.style.display = 'none';
				div.canceled = canceled;
				div.appendChild(canceled);
				
				
				$("download-container").appendChild(div);
				setItemsPosition();

				checkScroller();

				path = video.path;
				var downloadItem = {
				    status          : 1,
					downloadCounter : downloadCounter,
					video		    : video,
					url				: video.downloadURL,
					path			: video.path,
					folder          : video.folder,
					fileName        : video.fileName,
					div			    : div,
					progressBar		: progressBar,
					progressBarText : progressBarText
				}
				div.downloadItem   = downloadItem;
				right.downloadItem = downloadItem;
				downloadCounter++
				currentDownloads.push(downloadItem);
				setItemByMode(div);

				var url = video.downloadURL;


				showDownloadItem(downloadItem)

				var ios = Components.classes['@mozilla.org/network/io-service;1']
						            .getService(Components.interfaces.nsIIOService);  
				var uri = ios.newURI(url, null, null); 
				var file = Components.classes["@mozilla.org/file/local;1"]
							         .createInstance(Components.interfaces.nsILocalFile);  
				file.initWithPath(path);  

				const nsIWBP = Components.interfaces.nsIWebBrowserPersist;

				var persist = Components.classes['@mozilla.org/embedding/browser/nsWebBrowserPersist;1'].createInstance(Components.interfaces.nsIWebBrowserPersist);  
				persist.persistFlags = nsIWBP.PERSIST_FLAGS_BYPASS_CACHE 

				persist.progressListener = {
					 onProgressChange : function(aWebProgress, aRequest, aCurSelfProgress, aMaxSelfProgress, aCurTotalProgress, aMaxTotalProgress) {

						var completed = (aCurTotalProgress / aMaxTotalProgress) * 100;

						try {
							setProgress(aCurSelfProgress, aMaxSelfProgress, completed, downloadItem);
						} catch(ex) {}
					 },
					 onStateChange : function(aWebProgress, aRequest, aStatus, aMessage) {
						 // downloadList[index+""].state = persist.currentState;
						  if (aMessage==2152398878) {
								//error
						  }
					 }
				}	

				persist.saveURI(uri, null, null, null, null, file);
				downloadItem.persist = persist;
			}

			function cancelDownload(downloadItem) {
				  var persist  = downloadItem.persist;
				  persist.cancelSave();
				  try {
					  var file = Components.classes["@mozilla.org/file/local;1"].createInstance(Components.interfaces.nsILocalFile);  
					  file.initWithPath(downloadItem.path);
					  file.remove(false);
				  } catch(ex) {}
			}
			function checkCloseBar() {
				if ($("download-container").childNodes.length==0) {
					nsIDOMWindow.fastYoutubeDownloader.onDownloadItemsClear();
				} else {
				    checkScroller();
				}
			}

			function openVideoDownloadMenu(e) {
				  var nsIDOMWindow = window.QueryInterface(Components.interfaces.nsIInterfaceRequestor)
										  .getInterface(Components.interfaces.nsIWebNavigation)
										  .QueryInterface(Components.interfaces.nsIDocShellTreeItem)
										  .rootTreeItem
										  .QueryInterface(Components.interfaces.nsIInterfaceRequestor)
										  .getInterface(Components.interfaces.nsIDOMWindow);	
				  if ((e.target.id=="bar-download-container") || (e.currentTarget.id=="bar-download-container")) {
					  var videoDownloadMenu = nsIDOMWindow.document.getElementById("videoDownloadMenuAll");
				  } else {
					  var downloadItem = e.currentTarget.downloadItem;
					  if (downloadItem.status == 1 ) {
						 var videoDownloadMenu = nsIDOMWindow.document.getElementById("videoDownloadMenuInProgress");
					  } else if (downloadItem.status == 2 ) {
						 var videoDownloadMenu = nsIDOMWindow.document.getElementById("videoDownloadMenuFinished");
					  } else if (downloadItem.status == -1 ) {
						 var videoDownloadMenu = nsIDOMWindow.document.getElementById("videoDownloadMenuCanceled");
					  }
					  videoDownloadMenu.div = e.currentTarget;
				  }
				 
				  var onCommand = function(e) {
					  var div = e.currentTarget.div
					  switch (e.target.value) {
							case "openFile": 
								var file = Components.classes["@mozilla.org/file/local;1"]
										 .createInstance(Components.interfaces.nsILocalFile);  
								file.initWithPath(div.downloadItem.path);  
								file.launch();
							return;
							case "openFolder": 
								var file = Components.classes["@mozilla.org/file/local;1"]
										 .createInstance(Components.interfaces.nsILocalFile);  
								file.initWithPath(div.downloadItem.folder);  
								file.launch();
							return;
							case "youtubePage": 
								openYoutubePage(div.downloadItem.video.videoId)
							return;
							case "cancel": 
								if (div.downloadItem.status==2) return;
								cancelDownload(div.downloadItem); 
								setCanceled(div.downloadItem); 
							return;
							case "remove": 
								if (div.downloadItem.status==1) cancelDownload(div.downloadItem); 
								//clearCompleted(div.downloadItem); 
								hideDownloadItem(div.downloadItem, function() {
									$("download-container").removeChild(div.downloadItem.div);
									setItemsPosition();
									checkCloseBar();
								})
							return;
							case "cancelAll": 
								for (var i=0;i<currentDownloads.length;i++) {
									if (currentDownloads[i].status==1) {
										setCanceled(currentDownloads[i]); 
									}
								}
							return;
							case "clearFinish": 
								for (var i=0;i<currentDownloads.length;i++) {
									if ((currentDownloads[i].status==2) || (currentDownloads[i].status==-1)){
										$("download-container").removeChild(currentDownloads[i].div);
										setItemsPosition();
										checkCloseBar();
										//hideDownloadItem(currentDownloads[i], function() {
										//	$("bar").removeChild(currentDownloads[i].div);
										//})
									}
								}	
								checkCloseBar();
							return;



					  }
				  }
				  var onPopupHidden = function(e) {
						if (e.target==e.currentTarget) {
							videoDownloadMenu.removeEventListener("popuphidden", onPopupHidden, false);
							videoDownloadMenu.removeEventListener("command", onCommand, false);
						}
				  }
				  videoDownloadMenu.addEventListener("popuphidden",onPopupHidden, false);
				  videoDownloadMenu.addEventListener("command", onCommand,  false);
				  videoDownloadMenu.openPopupAtScreen(e.screenX, e.screenY, true);
				  e.preventDefault();	
			}

			function openYoutubePage(videoId) {
			
					 var win = window.QueryInterface(Components.interfaces.nsIInterfaceRequestor)
										   .getInterface(Components.interfaces.nsIWebNavigation)
										   .QueryInterface(Components.interfaces.nsIDocShellTreeItem)
										   .rootTreeItem
										   .QueryInterface(Components.interfaces.nsIInterfaceRequestor)
										   .getInterface(Components.interfaces.nsIDOMWindow);				
					 var url = "http://www.youtube.com/watch?v=" + videoId;
					 var browser = win.getBrowser();
					 browser.selectedTab = browser.addTab(url);
			}

			function $(id) {
				return document.getElementById(id);
		    }


		</script>
   </head>
   <body onload="pageLoaded()">
	  <div id="bar">
	     <div id="scroll-left"></div>
	     <div id="bar-download-container">
		   <div id="download-container"></div>
		 </div>
		 <div id="right"></div>
	     <div id="scroll-right"></div>
	  </div>
   </body>
</html>